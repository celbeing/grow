{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ student.name }}의 제빵사</title>
    <style>
        body {
            background-color: #fdf1e6;
            font-family: Arial, sans-serif;
            padding: 40px;
            text-align: center;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 20px;
        }

        pre {
            background-color: #fde3b2;
            padding: 20px;
            border-radius: 10px;
            display: inline-block;
            text-align: left;
            font-size: 16px;
            border: 1px solid #ccc;
        }

        .container {
            width: 300px;
            height: 300px;
            transition: all 0.1s;
            display: block;
            margin: 0 auto;
        }

        .skill-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            justify-content: center;
        }

        .skill-label {
            width: 160px;
            text-align: right;
            margin-right: 10px;
            font-size: 15px;
        }

        .skill-bar-container {
            width: 250px;
            height: 20px;
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin-right: 10px;
        }

        .skill-bar {
            height: 100%;
            background-color: orange;
            width: 0%;
            transition: width 0.2s;
        }
    </style>
</head>
<body>
    <h1>{{ student.name }}의 제빵사</h1>
    <div class="container">
        <img id="avatar-img" src="{% static avatar_path %}" alt="Math Avatar" style="max-width: 300px; margin-top: 20px;">
    </div>
    <br>
    <div id="skills">
        {% for skill_key, skill_label in math_skills.items %}
        <div class="skill-row">
            <span class="skill-label">{{ skill_label }}</span>
            <div class="skill-bar-container">
                <div class="skill-bar" id="bar-{{ skill_key }}"></div>
            </div>
            <button onclick="updateScore('{{ skill_key }}', 1)">▲</button>
            <button onclick="updateScore('{{ skill_key }}', -1)">▼</button>
        </div>
        {% endfor %}
    </div>
    <script>
        const container = document.querySelector('.container');
        container.addEventListener('mousemove', function (e) {
            const x = e.offsetX;
            const y = e.offsetY;
            const rotateX = 4 / 30 * y - 20;
            const rotateY = -1 / 5 * x + 20;
            container.style = `transform : perspective(350px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
        });

        container.addEventListener('mouseout', function () {
            container.style = `transform : perspective(350px) rotateY(0deg) rotateX(0deg)`;
        });

        const studentId = {{ student.id }};
        const maxScore = 50;

        const scores = {
            {% for skill_key in math_skills.keys %}
            "{{ skill_key }}": {{ student|get_item:skill_key }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        };

        function updateBar(skill) {
            const percent = (scores[skill] / maxScore) * 100;
            document.getElementById("bar-" + skill).style.width = percent + "%";
        }

        function updateScore(skill, delta) {
            fetch("/ajax/update_score/", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `student_id=${studentId}&key=${skill}&delta=${delta}`
            })
            .then(res => res.json())
            .then(data => {
                if (data.new_score !== undefined) {
                    scores[skill] = data.new_score;
                    updateBar(skill);
                }
            });
        }

        function getAvatarImagePath(total) {
            if (total <= 30) return "{% static 'images/math/avatar_math_lv1.png' %}";
            else if (total <= 60) return "{% static 'images/math/avatar_math_lv2.png' %}";
            else if (total <= 80) return "{% static 'images/math/avatar_math_lv3.png' %}";
            else return "{% static 'images/math/avatar_math_lvmax.png' %}";
        }

        function updateAvatarImage() {
            const total = Object.values(scores).reduce((a, b) => a + b, 0);
            const newSrc = getAvatarImagePath(total);
            document.getElementById("avatar-img").src = newSrc;
        }


        window.onload = function () {
            Object.keys(scores).forEach(updateBar);
        };

        fetch("/ajax/update_score/", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `student_id=${studentId}&key=${skill}&delta=${delta}`
        })
            .then(res => res.json())
            .then(data => {
                if (data.new_score !== undefined) {
                    scores[skill] = data.new_score;
                    updateBar(skill);
                    updateAvatarImage();
                }
            });

    </script>
</body>
</html>

